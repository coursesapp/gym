<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>طلب الباقة - نمط محادثة</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #ff5722;
        --secondary-color: #ffc107;
        --bg-color: #f4f4f4;
        --bubble-color: #fff;
        --bubble-user: #e0f7fa;
        --text-color: #212121;
      }

      body {
        font-family: "Cairo", sans-serif;
        margin: 0;
        background-color: var(--bg-color);
        display: flex;
        flex-direction: column;
        height: calc(var(--vh, 1vh) * 100);
      }

      .chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
      }

      .bubble {
        max-width: 80%;
        padding: 0.8rem 1rem;
        margin: 0.4rem 0;
        border-radius: 1rem;
        background-color: var(--bubble-color);
        color: var(--text-color);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }

      .bubble.user {
        align-self: flex-start;
        background-color: var(--bubble-user);
      }

      .form-input {
        display: flex;
        flex-direction: column;
        margin-top: 0.5rem;
      }

      input,
      select,
      textarea,
      button {
        font-family: inherit;
        font-size: 1rem;
        margin-top: 0.3rem;
        padding: 0.7rem;
        border-radius: 8px;
        border: 1px solid #ccc;
        width: 95%;
      }

      button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        cursor: pointer;
        transition: background 0.3s;
      }

      button:hover {
        background-color: #e64a19;
      }

      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.6);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: inline-block;
        vertical-align: middle;
        margin-inline-start: 8px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .chat-footer {
        padding: 1rem;
        border-top: 1px solid #ddd;
        background-color: #fff;
        display: flex;
        justify-content: space-between;
        gap: 1rem;
      }

      .toolbar {
        display: flex;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: #fff;
        border-bottom: 1px solid #ddd;
      }

      .preview-img {
        max-width: 100%;
        margin-top: 0.5rem;
        border-radius: 8px;
      }

      .hidden {
        display: none;
      }
      .selected-plan {
        font-weight: bold;
        margin-right: auto;
        color: var(--primary-color);
      }
    </style>
  </head>
  <body data-page="order">
    <div class="toolbar">
      <button id="lang-toggle" onclick="toggleLanguage()">EN</button>
    </div>

    <div class="chat-container" id="chat"></div>

    <div class="chat-footer">
      <div id="selectedPlan" class="hidden"></div>
      <button id="restartBtn">إعادة</button>
      <button id="nextBtn">التالي</button>
    </div>

    <script src="i18n.js"></script>
    <script>
      const chat = document.getElementById("chat");
      const nextBtn = document.getElementById("nextBtn");
      const restartBtn = document.getElementById("restartBtn");

      const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxcU7Sx-A9ZcB7g0hu1cPxB2MplxRzXBz4wz6OrVyhit0FVAt0jI1fJgdyVSST0Vwd9/exec";
      let uploadedFiles = {};
      let uploadedFilesBase64 = {};
      let fileReadPromises = {};
      let isSubmitting = false;
      let isSubmitted = false;

      function getStepsTexts() {
        const o = I18N.getOrderTexts();
        return [
          { id: "name", label: o.steps.name, type: "text" },
          { id: "gender", label: o.steps.gender, type: "select", options: o.steps.gender_options },
          { id: "age", label: o.steps.age, type: "number" },
          { id: "phone", label: o.steps.phone, type: "tel" },
          { id: "email", label: o.steps.email, type: "email" },
          { id: "location", label: o.steps.location, type: "text" },
          { id: "height", label: o.steps.height, type: "number" },
          { id: "weight", label: o.steps.weight, type: "number" },
          { id: "job", label: o.steps.job, type: "text" },
          { id: "best_time", label: o.steps.best_time, type: "text" },
          { id: "training_place", label: o.steps.training_place, type: "text" },
          { id: "level", label: o.steps.level, type: "select", options: o.steps.level_options },
          { id: "used_supplements", label: o.steps.used_supplements, type: "select", options: o.steps.used_supplements_options },
          { id: "used_hormones", label: o.steps.used_hormones, type: "select", options: o.steps.used_hormones_options },
          { id: "injuries", label: o.steps.injuries, type: "textarea" },
          { id: "health_status", label: o.steps.health_status, type: "textarea" },
          { id: "medical_tests", label: o.steps.medical_tests, type: "file", preview: true },
          { id: "front_image", label: o.steps.front_image, type: "file", preview: true },
          { id: "side_image", label: o.steps.side_image, type: "file", preview: true },
          { id: "back_image", label: o.steps.back_image, type: "file", preview: true },
          { id: "goal", label: o.steps.goal, type: "textarea" },
        ];
      }

      let steps = getStepsTexts();
      let step = 0;
      let answers = JSON.parse(localStorage.getItem("orderAnswers")) || {};

      function getQueryParam(name){
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
      }

      function renderOrder() {
        steps = getStepsTexts();
        const o = I18N.getOrderTexts();
        chat.innerHTML = "";

        // Selected plan (if passed)
        const plan = getQueryParam('plan');
        if (plan) {
          const planBubble = document.createElement('div');
          planBubble.className = 'bubble';
          const label = document.createElement('strong');
          label.id = 'selected-plan-label';
          label.textContent = o.selected_plan_label;
          planBubble.appendChild(label);
          planBubble.appendChild(document.createTextNode(' ' + plan));
          chat.appendChild(planBubble);
        }

        const greeting = document.createElement("div");
        greeting.className = "bubble";
        greeting.textContent = o.greeting;
        chat.appendChild(greeting);

        for (let i = 0; i < step; i++) {
          const q = steps[i];
          const qBubble = document.createElement("div");
          qBubble.className = "bubble";
          qBubble.textContent = q.label;
          chat.appendChild(qBubble);

          const aBubble = document.createElement("div");
          aBubble.className = "bubble user";
          aBubble.textContent = answers[q.id];
          chat.appendChild(aBubble);
        }

        if (step < steps.length) {
          const q = steps[step];
          const bubble = document.createElement("div");
          bubble.className = "bubble";
          bubble.textContent = q.label;
          chat.appendChild(bubble);

          const inputWrapper = document.createElement("div");
          inputWrapper.className = "form-input";

          if (q.type === "select") {
            const select = document.createElement("select");
            select.id = q.id;
            q.options.forEach((opt) => {
              const option = document.createElement("option");
              option.value = opt;
              option.textContent = opt;
              select.appendChild(option);
            });
            inputWrapper.appendChild(select);
          } else if (q.type === "textarea") {
            const textarea = document.createElement("textarea");
            textarea.id = q.id;
            inputWrapper.appendChild(textarea);
          } else {
            const input = document.createElement("input");
            input.type = q.type;
            input.id = q.id;
            input.placeholder = q.placeholder || "";
            if (q.type === "file") input.accept = "image/*";
            inputWrapper.appendChild(input);
          }

          chat.appendChild(inputWrapper);
        } else {
          const finalBubble = document.createElement("div");
          finalBubble.className = "bubble";
          finalBubble.textContent = o.finished;
          chat.appendChild(finalBubble);
          nextBtn.disabled = true;
          if (!isSubmitting && !isSubmitted) {
            isSubmitting = true;
            submitOrder();
          }
        }

        // Update buttons
        restartBtn.textContent = o.restart_btn;
        const isLastQuestion = step === steps.length - 1;
        const isFinished = step >= steps.length;
        if (isSubmitting) {
          nextBtn.disabled = true;
          nextBtn.innerHTML = (o.next_btn === 'Next' ? 'Submitting...' : 'جاري التسليم...') + ' <span class="spinner"></span>';
          restartBtn.disabled = true;
        } else if (isFinished) {
          nextBtn.disabled = true;
          nextBtn.textContent = o.next_btn;
          restartBtn.disabled = false;
        } else {
          nextBtn.disabled = false;
          nextBtn.textContent = isLastQuestion ? (o.next_btn === 'Next' ? 'Submit' : 'تسليم') : o.next_btn;
          restartBtn.disabled = false;
        }

        chat.scrollTop = chat.scrollHeight;
      }
      window.renderOrder = renderOrder;

      nextBtn.addEventListener("click", () => {
        const o = I18N.getOrderTexts();
        const prevInput = document.querySelector(
          ".form-input input, .form-input select, .form-input textarea"
        );
        if (!prevInput) return;

        if (prevInput.type === "file") {
          const file = prevInput.files[0];
          if (!file) return alert(o.select_file_alert);
          answers[steps[step].id] = file.name;
          uploadedFiles[steps[step].id] = file;
          const reader = new FileReader();
          const readPromise = new Promise((resolve) => {
            reader.onload = () => {
              const base64 = String(reader.result).split(",")[1] || "";
              uploadedFilesBase64[steps[step].id] = {
                name: file.name,
                type: file.type,
                base64: base64,
              };
              resolve(true);
            };
          });
          fileReadPromises[steps[step].id] = readPromise;
          reader.readAsDataURL(file);
          const preview = document.createElement("img");
          preview.className = "preview-img";
          preview.src = URL.createObjectURL(file);
          chat.appendChild(preview);
        } else {
          const value = prevInput.value.trim();
          if (!value) return alert(o.required_alert);
          answers[steps[step].id] = value;
        }
        localStorage.setItem("orderAnswers", JSON.stringify(answers));
        step++;
        renderOrder();
      });

      restartBtn.addEventListener("click", () => {
        localStorage.removeItem("orderAnswers");
        step = 0;
        answers = {};
        nextBtn.disabled = false;
        renderOrder();
      });

      async function submitOrder() {
        try {
          isSubmitting = true;
          await Promise.all(Object.values(fileReadPromises));

          const payload = {};
          const plan = getQueryParam('plan');
          if (plan) payload.plan = plan;

          steps.forEach((q) => {
            if (q.type !== 'file') {
              if (answers[q.id] != null) payload[q.id] = answers[q.id];
            }
          });

          const filesPayload = {};
          ['medical_tests','front_image','side_image','back_image'].forEach((key) => {
            if (uploadedFilesBase64[key]) {
              filesPayload[key] = uploadedFilesBase64[key];
            }
          });
          payload.files = filesPayload;

          await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
            mode: 'no-cors',
          });

          alert('تم الإرسال بنجاح');
          isSubmitted = true;
          localStorage.removeItem("orderAnswers");
        } catch (error) {
          console.error(error);
          alert('حصل خطأ أثناء الإرسال. حاول مرة أخرى.');
        } finally {
          isSubmitting = false;
          renderOrder();
        }
      }

      // إذا كانت هناك بيانات محفوظة، استكمل الخطوات تلقائيًا
      if (Object.keys(answers).length > 0) {
        step = Object.keys(answers).length;
      }

      // style
      function setVh() {
        document.documentElement.style.setProperty(
          "--vh",
          `${window.innerHeight * 0.01}px`
        );
      }
      setVh();
      window.addEventListener("resize", setVh);

      // Initialize language and render
      I18N.init();
      renderOrder();

      // التعامل مع زر Enter أو Go في الموبايل
      document.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const activeElement = document.activeElement;

          // منع عمل سطر جديد في textarea
          if (activeElement.tagName === "TEXTAREA") {
            e.preventDefault();
            nextBtn.click();
          }

          // لو input أو select
          if (
            activeElement.tagName === "INPUT" ||
            activeElement.tagName === "SELECT"
          ) {
            e.preventDefault();
            nextBtn.click();
          }
        }
      });
    </script>
  </body>
</html>
